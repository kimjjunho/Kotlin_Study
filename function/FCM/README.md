# FCM

### FCM이란?

- **FCM**은 **Firebase Cloud Messaging**의 약자로, 무료로 메시지를 안정적으로 전송할 수 있는 교차 플랫폼 메시징 솔루션이다.
- 모든 사용자에게 알림 메세지를 전송할 수도 있고, 그룹을 지어 메시지를 전송할 수도 있다.

### FCM의 주요 특징

- 메세지 타입

  1. 알림메시지
     - 여러 알림을 저장하나, OS 환경마다 다르다. (알림 저장 개수)
     - 앱이 백그라운드 일 때 (알림 처리 방법)
  2. 데이터메시지
     - 1개의 알림만 저장 (알림 저장 개수)
     - 앱이 포그라운드 일 때 (알림 처리 방법)

  - 보통 알림 메세지와 데이터 메시지를 같이 혼용해서 사용한다.
  - 모두 알림 기능이 가능하다

- 타겟팅

  - 단일 기기, 기기 그룹, 주제를 구독한 기기 3가지 방식으로 클라이언트 앱에 메시지를 배포할 수 있다.
    1. 단일기기 / 1개 / 하나의 기기(앱기준)
    2. 기기그룹 / 20개 / 알림 키에 허용되는 그룹
    3. 주제구독 / 1000개 / 등록 토큰에 구독된 기기
  - 클라이언트 앱에서 메시지 전송
    - 앱 서버에서 클라이언트 앱으로 다운 스트림 메세지를 보낼 수 있다
    - 앱에서 앱 서버로도 업 스트림 메세지를 보낼 수 있다. (선행 조건 필요)

### FCM의 동작 원리

- 크게 송신자, FCM Backend Server, 수신자로 구분한다.

  Notifications Console GUI -> Firebase - CloudMassaging -> 클라이언트

  Trusted Environment <-> Firebase - CloudMassaging -> 클라이언트

- 송신자

  1. 앱 서버
  2. HTTP 프로토콜을 사용하는 서버
  3. Firebase Console GUI 등

- 수신자

  1. iOS Android 운영체제를 이용하는 모바일 기기

- FCM Backend 서버

  - 실질적으로 앱 서버에서 요청을 받아서 메세지를 처리하는 서버에 해당된다.

- FCM 클라우드 메시지의 흐름

  - HTTP 프로토콜을 사용할 경우

    1. 앱 서버 -> FCM 연결 서버
    2. FCM연결 서버 -> 앱 서버
    3. FCM연결 서버 -> 안드로이드 앱(클라이언트)
    4. 안드로이드 앱(클라이언트) -> FCM연결 서버

    ![img](https://user-images.githubusercontent.com/33312179/80870526-f8ec7e00-8ce1-11ea-90d0-d3e474d0218d.png)

### FCM을 사용하기 위한 서버 환경 구성

- FCM Backend 서버에 **FCM에서 지정한 형식의 메시지** 요청을 보낼 수 있어야 한다.
- **지수 백오프**를 사용하여 요청을 처리하고 다시 보낼 수 있어야 한다. (연쇄 충돌 방지)
- 서버 승인 사용자의 **인증 정보**와 클라이언트의 **등록 토큰**을 안전하게 저장 할 수 있어야 한다.

### 용어 설명

- 클라이언트 앱 
  - 안드로이드 단말에서 FCM을 사용하는 앱
- 앱 서버
  - 클라이언트 앱에 전달되는 토큰 관리
  - 클라이언트 앱에 메세지를 전달할 수 있도록 FCM에 메세지를 전달
- API Key
  - Google Develop Console에서 받는 API키
  - 앱 서버에서 저장 관리 됨
  - HTTP프로토콜로 메시지를 보낼 때 POST의 헤더에 포함됨
  - 클라이언트 앱의 코드에 API키를 포함하지 않도록 주의한다
- Sender ID
  - FCM 앱 등록으로 발급된 google-services.json파일의 project_number에 해당되는 값이다.
  - 클라이언트 앱에서 Registration Token을 발급받기 위해 FCM에 전달하는 값으로 사용됨
- Application ID
  - Application ID는 Android에서 Package Name을 의미한다
  - Package Name은 앱을 구분하는 단위로 하나의 앱은 중복되지 않은 Package Name을 가져야 한다.
- Registration Token
  - FCM에서 발급받은 토큰
  - 웹 서버에 전달하여 클라이언트 앱에 메시지 알림을 전송할 때 사용된다

### HTTP와 XMPP

- HTTP
  - 단방향 메시지(Downstream)
  - 동기 방식
  - Plain Text, JSON
  - 단순히 푸시 메시지를 보내는 기능만 필요한 경우
- XMPP
  - 양방향 메시지(Upstream/Downstream)
  - 비동기 방식
  - JSON 암호화
  - 카카오톡과 같은 채팅 서비스처럼 양방향 통신이 필요한 경우

### FCM 토큰 생성 및 삭제

- 앱을 처음 실행할때 클라이언트 앱 인스턱스에 대한 등록 토큰으 생성한다
- FCM토큰은 정해진 수명이나 갱신 주기가 없다
- 만료 되는 경우
  - 앱이 인스턴스 ID를 삭제한 경우
  - 앱이 새 기기에서 복원되었을 경우
  - 사용자가 앱을 제거/재설치한 경우
  - 사용자가 앱 데이터를 지운 경우
- onTokenRefresh() 메서드는 토큰이 갱신될 때마다 호출된다(갱신될 때마다 동작해야 하는 로직이 있다면, 해당 메서드를 오버라이딩하여 구현한다)

### 고려해야 할 부분

- 같은 기기에서 다른 아이디를 쓰는 경우 - 로그아웃 시점에 서버에서 유저 토큰을 삭제하낟

- 같은 아이디로 여러 기기를 쓰는 경우 - 하나의 유저가 여러 토큰을 보유할 수 있게 스키마를 구성

- 토큰이 갱신되어 서버와 동기화가 필요한 경우 

  -onTokenRefresh() 메서드를 오버라이딩하여 로그인된 유저의 토큰이 갱신될 경우 서버로 토큰을 업데이트하는 api를 전송

- 오래된 등록 토큰이 있는 비활성 장치에 메시지를 전송하여 리소스를 낭비하는 경우

### 클라이언트에서 해야 할 것

- FCM에 앱 등록
- 앱에 FCM연동
- 서버에 로그인 요청할 때 FCM 토큰 전송(등록)
- 서버에 로그아웃 요청할 때 FCM 토큰 전송(삭제)
- 앱을 실행할 때 로그인되어 있으면 FCM토큰을 서버에 전송(타임스탬프 갱신)
- FCM 토큰이 갱신될 때 로그인되어 있으면 FCM 토큰을 서버에 전송

​	

- https://donghun.dev/Firebase-Cloud-Messaging
- https://m.blog.naver.com/devks0228/221666814076
- https://seungwoolog.tistory.com/88?category=1019746

